#!/usr/bin/env bats

load 'helpers/bats-support/load'
load 'helpers/bats-assert/load'

@test "unknown command results in error" {
    run ./bin/flipt foo
    assert_failure
    assert_equal "${lines[0]}" "Error: unknown command \"foo\" for \"flipt\""
    assert_equal "${lines[1]}" "Run 'flipt --help' for usage."
}

@test "config file does not exists results in error" {
    run ./bin/flipt --config /foo/bar.yml
    assert_failure
    assert_output -p "loading config: open /foo/bar.yml: no such file or directory"
}

@test "config file not yaml results in error" {
    run ./bin/flipt --config /tmp
    assert_failure
    assert_output -p "loading config: Unsupported Config Type"
}

@test "help flag prints usage" {
    run ./bin/flipt --help
    assert_success
    assert_equal "${lines[0]}" "Flipt is a modern feature flag solution"
    assert_equal "${lines[1]}" "Usage:"
    assert_equal "${lines[2]}" "  flipt [flags]"
    assert_equal "${lines[3]}" "  flipt [command]"
    assert_equal "${lines[4]}" "Available Commands:"
    assert_equal "${lines[5]}" "  export      Export flags/segments/rules to file/stdout"
    assert_equal "${lines[6]}" "  help        Help about any command"
    assert_equal "${lines[7]}" "  import      Import flags/segments/rules from file"
    assert_equal "${lines[8]}" "  migrate     Run pending database migrations"
    assert_equal "${lines[9]}" "Flags:" ]
    assert_equal "${lines[10]}" "      --config string   path to config file (default \"/etc/flipt/config/default.yml\")"
    assert_equal "${lines[11]}" "  -h, --help            help for flipt"
    assert_equal "${lines[12]}" "      --version         version for flipt"
}

@test "version flag prints version info" {
    run ./bin/flipt --version
    assert_success
    assert_output -p "Version:"
    assert_output -p "Commit:"
    assert_output -e "Build Date: [0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}Z"
    assert_output -e "Go Version: go[0-9]+\.[0-9]+\.[0-9]"
}

@test "export outputs to stdout" {
    run ./bin/flipt --config script/test/test.yml export
    assert_output -p "flags:"
    assert_output -p "- key: zUFtS7D0UyMeueYu"
    assert_output -p "  variants:"
    assert_output -p "  rules:"
    assert_output -p "segments:"
    assert_output -p "- key: 08UoVJ96LhZblPEx"
    assert_output -p "  constraints:"
    assert_success
}

@test "export outputs to file" {
    run ./bin/flipt --config script/test/test.yml export -o flipt.yaml
    run test -f "flipt.yaml"
    assert_success
}

@test "import succeeds with empty database" {
    run bash -c 'rm empty.db; FLIPT_DB_URL="file:./empty.db" ./bin/flipt --config ./script/test/test.yml import flipt.yaml'
    assert_success
}

@test "import fails with existing data not unique" {
    run ./bin/flipt --config ./script/test/test.yml import flipt.yaml
    assert_output -e "is not unique"
    assert_failure
}

@test "import succeeds with existing data not unique but --drop flag is used" {
    run ./bin/flipt --config ./script/test/test.yml import flipt.yaml --drop
    assert_success
}
